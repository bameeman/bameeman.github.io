<html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="mqttjs.html">



</head><body><dom-module id="mqtt-connection">
  <template>
    <content id="mqttSubscriptions" select="mqtt-subscription"></content>
    <content id="mqttPublications" select="mqtt-publish"></content>
    <content id="content"></content>
  </template>
</dom-module>

<script>"use strict";!function(t){var e=t.MqttElements=t.MqttElements||{};e.MqttConnection=Polymer({is:"mqtt-connection",properties:{maxListeners:{type:Number,value:10,observer:"_maxListenersChanged"},clean:{type:Boolean,readOnly:!1,value:!0},client:{type:Object,readOnly:!1,notify:!0,observer:"_clientChanged"},clientIdPrefix:{type:String,value:"mqttjs_"},connected:{type:Boolean,readOnly:!0,notify:!0,value:!1,observer:"_connectedChanged"},disconnecting:{type:Boolean,readOnly:!0,notify:!0,value:!1},mqEmitter:{type:Object,notify:!0,readOnly:!0,value:function(){return require("MQEmitter")()}},options:{type:Object,readOnly:!1,notify:!0,value:function(){return{protocolId:"MQTT",protocolVersion:4,keepalive:120,reconnectPeriod:1e3,clientId:"",encoding:"string"}}},username:{type:String,readOnly:!1,notify:!0,observer:"_usernameChanged"},password:{type:String,readOnly:!1,notify:!0,observer:"_passwordChanged"},publishers:{type:Array,notify:!0,readOnly:!0,value:function(){return[]}},subscriptions:{type:Array,notify:!0,readOnly:!0,value:function(){return[]}},url:{type:String,value:""},withCredentials:{type:Boolean,readOnly:!1,notify:!0,value:!1},auto:{type:Boolean,readOnly:!1,value:!1},packetQueue:{type:Array,value:function(){return[]}}},observers:["_usernameOrPasswordChanged(username, options.username, password, options.password, withCredentials, auto)","_autoChanged(auto, withCredentials)"],listeners:{"mqtt-subscription-register":"_subscriptionElementRegistered","mqtt-subscription-unregister":"_subscriptionElementUnregistered","mqtt-publish-register":"_publishElementRegistered","mqtt-publish-unregister":"_publishElementUnregistered"},attached:function(){this.client||!this.auto||this.withCredentials||this.connect()},_usernameChanged:function(t,e){this.set("options.username",t)},_passwordChanged:function(t,e){this.set("options.password",t)},_autoChanged:function(t,e){this.client||!t||e||this.connect()},_usernameOrPasswordChanged:function(t,e,n,i,s,o){!this.client&&o&&(!s||s&&(t||e)&&(n||i))&&this.connect()},_maxListenersChanged:function(t,e){this.client&&t&&this.client.setMaxListeners(t)},connect:function(){this._createClient()},disconnect:function(){this.client&&this.client.end(!0)},publish:function(t,e,n,i,s){var o={qos:n||0,retain:i||!1};if(this.client)this.client.publish(t,e,o,s);else{var r=function(){},c={cb:s||r,packet:{cmd:"publish",topic:t,payload:e,qos:n||0,retain:i||!1,messageId:1}};this.push("packetQueue",c)}},subscribe:function(t,e,n){var i={qos:e||0};this.client&&this.client.subscribe(t,i,n)},_addElementAndRegister:function(t,e){this.push(t,e),this._setParentConnectionOnElement(e)},_clientChanged:function(t){t&&t.on("close",this._handelClose.bind(this)).on("connect",this._handelConnected.bind(this)).on("error",this._handelError.bind(this)).on("message",this._handelMessage.bind(this)).on("offline",this._handelOffline.bind(this)).on("reconnect",this._handelReconnect.bind(this))},_connectedChanged:function(t,e){t?this._subscribeAllSubscriptions():e&&this._setUnsubscribedForAllSubscriptions()},_createClient:function(){var t=require("mqtt");t?this._createClientDebounce(t):(this.fire("mqtt-connection-error","<mqtt-connection> element could not load MQTT.js, pleas check your setup"),console.error("<mqtt-connection> element could not load MQTT.js, pleas check your setup"))},_createClientDebounce:function(t){this.options.clientId&&0==this.options.clientId.length&&this.set("options.clientId",this._generateClientId()),this.options.queue=this.packetQueue,this.client=t.connect(this.url,this.options),this.client.setMaxListeners(this.maxListeners)},_createSubscription:function(t){this.client&&(this.subscribe(t.topic,t.qos,t._handelSubscriptionSubscribedFunc),this.mqEmitter.on(t.topic,t._handelMessageFunc))},_generateClientId:function(){return this.clientIdPrefix+Math.random().toString(16).substr(2,8)},_getConnectionStatusOfConnection:function(t){return!!t&&t.connected},_handelClose:function(){this._setMqttConnected(this._getConnectionStatusOfConnection(this.client)),this.fire("mqtt-connection-close")},_handelConnected:function(){this._setMqttConnected(this._getConnectionStatusOfConnection(this.client)),this.fire("mqtt-connection-connected",{value:this.connected})},_handelError:function(){this.fire("mqtt-connection-error")},_handelMessage:function(t,e,n){this.fire("mqtt-message",{topic:t,message:e,packet:n}),this.mqEmitter.emit({topic:t,message:n})},_handelOffline:function(){this._setMqttConnected(this._getConnectionStatusOfConnection(this.client)),this.fire("mqtt-connection-offline",{value:this.connected})},_handelReconnect:function(){this.fire("mqtt-connection-reconnect")},_notifySubscriptionChanged:function(t){this._propagateElementChanged(t,"subscriptions")},_propagateElementChanged:function(t,e){var n=e,i=this[n].indexOf(t);if(i>=0){var s=Polymer.Collection.get(this.get(n)).getKey(this[n][i]);if(s>=0)for(var o=Object.getOwnPropertyNames(this[n][i].properties),r=0;r<o.length;r++){var c=[n,s,o[r]].join(".");Array.isArray(this[n][i][o[r]])?this.notifyPath(c,this[n][i][o[r]].slice()):this.notifyPath(c,this[n][i][o[r]])}}},_publishElementRegistered:function(t){this._addElementAndRegister("publishers",t.target)},_publishElementUnregistered:function(t){this._unregisterElement("publishers",t.detail.target)},_removeSubFromEmmitter:function(t){this.mqEmitter.removeListener(t.topic,t._handelMessageFunc)},_setMqttConnected:function(t){"boolean"==typeof t&&this._setConnected(t)},_setParentConnectionOnElement:function(t){t._parentConnection=this},_setUnsubscribedForAllSubscriptions:function(){for(var t=0;t<this.subscriptions.length;t++)this._setUnsubscribedToSubscription(this.subscriptions[t])},_setUnsubscribedToSubscription:function(t){this._removeSubFromEmmitter(t),t._handelSubscriptionUnsubscribed()},_subscribeAllSubscriptions:function(){for(var t,e=0;e<this.subscriptions.length;e++)t=this.subscriptions[e],t.subscribed||this._createSubscription(t)},_subscriptionElementRegistered:function(t){var e=t.target;this._addElementAndRegister("subscriptions",e),this.client&&this.client.connected&&this._createSubscription(e)},_subscriptionElementUnregistered:function(t){var e=t.detail.target;e&&(e.topic&&this.client&&(this.client.unsubscribe(e.topic,e._handelSubscriptionUnsubscribed.bind(e)),this._removeSubFromEmmitter(e)),this._unregisterElement("subscriptions",e))},_unregisterElement:function(t,e){this.arrayDelete(t,e)}})}(window);</script>
</body></html>